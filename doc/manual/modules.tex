\chapter{The Modules}

\section{Satellite super module}
The satellite super-module (internally represented by the class NSatellite) provides an interface to all other satellite modules, which are required by various other simulation and analysis modules.
\subsection{Orbit engine}
The orbit engine provides information about the current orbit position of the satellite, e.g. altitude, inclination, position in TBD coordinates.

\subsection{Pointing engine}
\begin{figure}[tb]
\begin{center}
\includegraphics[width=10cm]{images/pointingGUI.png}  
\caption{Pointing module options GUI.}
\label{pointinggui} 
\end{center}
\end{figure}
The pointing engine provides the pointing of the focal plane module in declination and right ascension. Figure \ref{pointinggui} shows the options interface gui for the pointing module. As illustrated the pointing module allows the user to define multiple pointings. Each pointing requires a coordinate set and an exposure time. Checking the box in the upper left turns the exposure times into absolute seconds, where as leaving it unchecked, the times become relative to the integration time given by the supervisor.

\subsection{Orientation and alignment engine}
\begin{figure}[tb]
\begin{center}
\includegraphics[width=10cm]{images/DBgui.png}  
\caption{Database and alignments options GUI.}
\label{dbgui} 
\end{center}
\end{figure}

The database and alignments module controls input databases and Figure \ref{dbgui} shows the interface options gui. Each database entry comes in two forms: the ideal alignment of the system as defined "pre-flight", and the "in-flight" alignments which will be subject to thermal perturbations. The databases are divided into 3 groups: the optics, the metrology and star tracker, and finally the rest of the spacecraft alignments. The optics, metrology and star tracker are kept separate so that they can be changed frequently without having to redo the other databases.

\subsection{Time engine}
At the moment the time engine provides the absolute time of the satellite. Modules such as the detector module, the metrology and star tracker module derive their own time from this absolute satellite time and transfer it to the event, star tracker and metrology data sets.   

\subsection{Geometry and detector properties} 

\section{Event pipeline}

\subsection{Source engine}
\begin{figure}[tb]
\begin{center}
\includegraphics[width=8cm]{images/sourceGUI.png}  
\caption{Source module options GUI.}
\label{sourcegui} 
\end{center}
\end{figure}
The source module generates the initial spatial and spectral photon distribution for the simulator. Figure \ref{sourcegui} shows the options interface gui for the source module. Multiple sources can be generated and each source needs to have specified a beam type, spectral type and a flux. It is important to note the the flux here is in (ph/mm$^2$/s) and NOT (ph/cm$^2$/s) as is common for most of the HEASOFT software package,
 
 The beam type defines the geometry and the position of the source. The position is absolute and in degrees. Make sure that the source and telescope pointing matches. The beam type geometry has the following options:
 \begin{itemize}
 \item \textbf{Point source (far field)}: This is a point source at infinity.
 \item \textbf{Disk souce (far field)}: This creates a disc at infinity defined by its radius.
 \item \textbf{Point source (near field)}: This is used for mimicking a calibration source at a finite distance above the detector
 \item \textbf{Pencil beam (near field)}: xxx
 \item \textbf{Read from fits file}: This creates a photon field based on a fits intensity image.
 \end{itemize}
 
 The spectral options are:
\begin{itemize} 
\item \textbf{Mono-energetic}
\item \textbf{Linear}
\item \textbf{Power-law}
\item \textbf{Broken power-law}
\item \textbf{Black body}
\item \textbf{File with differential flux}: read differential spectrum from an ASCII file normalized to the input flux. An example file of the format can be found at:\\
\textbf{ /resource/data/SourceGenerator.examplespectrum.dat}
\end{itemize}
For the sources at infinite distance the photons are started randomly from a disk on a sphere surrounding the opening of the optics modules (the module is chosen randomly) to enable the correct simulation of the effective area as a function of incidence angle. The start time is randomly determined (Poisson distribution) according to the source flux. When the start position, start direction and photon energy are determined, the photon is handed over to the optics module for further simulation.

\subsection{Optics engine}
The optics engine is a full-fledged raytrace to simulate the actual optics. It incorporates the exact geometry of the optics, and uses externally generated reflectivity files to calculate the reflection of the photons off the mirrors. Additionally it has a module to simulate deflection of the xray photons due to mirror imperfections, which will generate the mirror point spread function. The raytrace also keeps track of single reflections, called "ghost rays", where the photon only reflects off one mirror while passing through.

The module has three options:
\begin{itemize}
\item \textbf{Scattering}: This options turns on the scattering of the photons due to figure errors in the mirrors. Scattering must be on for a science simulation. It is important to note that this is scattering in the reflection sense only, and not of any particle effects.
\item \textbf{Perfect Optics}: This option focuses all rays to one spot. This option should not be used with science simulations and is primarily for debugging.
\item \textbf{Ghost rays}: This option enables the ghost rays. As a default it should be on when running a science simulation. 
\end{itemize}

The input of this module is a photon location, direction and energy handed to it by the source module, and the output is location, direction and energy after the photon has exited the optics.


\subsection{Aperture engine}
The aperture engine places an aperture in the photon path and rejects any photon hitting the aperture. The aperture stop is located 833.187 mm above the detector, and has an opening diameter of 58 mm.

\subsection{Background engine}
\begin{figure}[tb]
\begin{center}
\includegraphics[width=8cm]{images/backgroundgui.png}  
\caption{Background interface options GUI for the "master background simulator".}
\label{bkggui} 
\end{center}
\end{figure}
The background engine draws the background from an external GEANT simulation, combining it with the expected background flux from the sky. This module has four options:
\begin{itemize}
\item \textbf{No Module}. It is possible to run NuSIM without having a background engine.
\item \textbf{Background Engine Trivial}. 
\item \textbf{Master Background Simulator}. As the name implies this is the actual background option to use when running science simulations. Figure \ref{bkggui} shows the interface options gui and the files can be found in\textbf{ /resouce/data/}.
\item \textbf{Event Loader: Universal loader}. Allows the user to load a previously saved event list.
\end{itemize}
\subsection{Detector interactions engine}

\subsection{Detector effects engine}

\subsection{Trigger engine}
The trigger module represents the trigger and downlink decision hardware aboard the NuSTAR satellite. It shall decide if an energy deposit in the shield represents a veto or the pattern on the detector is valid for a downlink.

\subsection{Detector data calibrator}

\subsection{Event selector}

\subsection{Science analyzer}

\section{Metrology and Star tracker pipeline}
\subsection{Metrology engine and calibrator}
The purpose of the metrology engine is to generate data at a rate equivalent to the onboard metrology system. The engine takes the known perturbed aspect of the instrument system and finds the intersection of the metrology laser with the metrology detector. It will then apply noise to the data set simulating the centroiding error of the metrology detector. This is done by applying a gaussian error to each of the measurement axis. The 1-sigma error is reported in the database file:\\ \textbf{resource/AlignmentDatabases/NuSim\_CompDB\_MET001.csv} . 

The engine passes the coordinates on to the Observatory Reconstructor for use in deriving the aspect reconstruction.

\subsection{Star tracker engine and calibrator}
Based on the input pointing defined by the pointing engine, the task of the Star Tracker Engine is to generate a quaternion, which defines the rotation between the Camera Head Unit, CHU, to the J2000.0 heliocentric inertial equatorial reference frame, also called VSN (Vernal, Summer, North). The origin is the intersection of the CCD plane with the optical axis of the camera. The CHU z-axis points along the boresight, and x/y axis span the CCD plane.
The output of the Star Tracker is a Quaternion that defines the attitude of the CHU w.r.t. the VSN, such that
\begin{equation} 
x_{CHU}=(Q_{CHU->VSN}) * x_{VSN}. 
\end{equation}
Thus if the a unit vector in the star tracker frame is transformed into the VSN frame by 
\begin{equation}
x_{VSN}=(Q_{CHU->VSN} )^T* x_{CHU}, 
\end{equation}
then RA=atan$(y_{VSN}/x_{VSN})$, DEC=acos$(z_{VSN})$. In the module $(Q_{CHU->VSN})^T$ is produced at a rate equivalent to the onboard Star Tracker. The module will add a gaussian noise to the transformation to mimick solution error of the Star Camera. The 1-sigma error is reported in the database file:\\ \textbf{resource/AlignmentDatabases/NuSim\_CompDB\_MET001.csv} .

 The transformation is passed on to the Observatory Reconstructor, which interpolates the transformation for a specific time and derives the aspect reconstruction.

\subsection{Observatory reconstructor}
The observatory reconstructor is the set of algorithms that solves the attitude and aspect problems of the NuSTAR observatory, given the metrology and star tracker data. The observatory reconstructor does not have access to the satellite module, which would contain the actual attitude and aspect of the observatory. It is responsible for re-calculating that attitude and aspect, given only a certain number of inputs, which are simulated satellite data.
The inputs to the observatory reconstructor are:
\begin{itemize}
\item The calibrated positions, in local coordinates, at which the metrology lasers impinge on their detectors. These are interpolated in time.
\item The calibrated star tracker data, which is a transformation (quaternion) from local star tracker coordinates to inertial (J2000.0) coordinates. These are interpolated in time. 
\item The on-ground alignment data defining the ideal locations of all the instrument components. Specifically, the pointing of the optical axis in optics bench coordinates, the location and pointing direction of the metrology laser in optics bench coordinates, the location and rotation to the metrology detector from focal plane bench coordinates and to the star tracker from optics bench coordinates.
\end{itemize}
The output from the observatory reconstructor is a transformation from focal plane module coordinates to celestial coordinate $R_{fbin}$.
For extensive details on this reconstruction, and the algorithm solution, see the memo “NuSTAR Pointing Reconstruction.”


\subsection{Observatory merger}
